name: Infra Code Review

on:
  workflow_dispatch:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review
    paths:
      # Trigger the workflow when resources are modified
      - "infra/resources/**"
      # Trigger the workflow when the involved workflows are modified
      - ".github/workflows/code_review_infra.yaml"

permissions:
  contents: read
  pull-requests: write
  id-token: write

jobs:
  detect_environments:
    runs-on: ubuntu-latest
    outputs:
      environments: ${{ steps.detect.outputs.environments }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect environments
        id: detect
        run: |
          # Find all directories containing .tf or .tf.json files, excluding those starting with underscore
          environments=$(find infra/resources -type f \( -name "*.tf" -o -name "*.tf.json" \) -exec dirname {} \; | \
            grep -v '/\._' | \
            grep -v '/_' | \
            sed 's|infra/resources/||g' | \
            sort -u | \
            jq -R -s -c 'split("\n")[:-1] | map(select(length > 0))')

          echo "environments=$environments" >> $GITHUB_OUTPUT
          echo "Found environments: $environments"

  code_review:
    needs: detect_environments
    if: needs.detect_environments.outputs.environments != '[]'
    strategy:
      matrix:
        environment: ${{ fromJson(needs.detect_environments.outputs.environments) }}
      fail-fast: false
    uses: pagopa/dx/.github/workflows/infra_plan.yaml@package-pr-comments-action
    name: Code Review Infra Plan (${{ matrix.environment }})
    secrets: inherit
    with:
      environment: ${{ matrix.environment }}
      override_github_environment: infra-dev
      base_path: infra/resources
