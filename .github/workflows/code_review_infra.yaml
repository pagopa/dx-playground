name: Infra Code Review

on:
  workflow_dispatch:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review
    paths:
      # Trigger the workflow when resources are modified
      - "infra/resources/**"
      # Trigger the workflow when source files that generate terraform are modified
      - "**/opex.ts"
      - "**/openapi*.yaml" 
      - "**/openapi/**/*.yaml"
      # Trigger the workflow when the involved workflows are modified
      - ".github/workflows/code_review_infra.yaml"

permissions:
  contents: read
  pull-requests: write
  id-token: write

jobs:
  detect_environments:
    runs-on: ubuntu-latest
    outputs:
      environments: ${{ steps.detect.outputs.environments }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Detect environments
        id: detect
        run: |
          # Get the list of changed files in the PR
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # For manual dispatch, run for all environments
            environments=$(find infra/resources -type f \( -name "*.tf" -o -name "*.tf.json" \) -exec dirname {} \; | \
              grep -v '/\._' | \
              grep -v '/_' | \
              sed 's|infra/resources/||g' | \
              sort -u | \
              jq -R -s -c 'split("\n")[:-1] | map(select(length > 0))')
          else
            # For PRs, only run for environments with changed files
            changed_files=$(gh pr diff ${{ github.event.number }} --name-only | grep '^infra/resources/' || true)
            
            if [ -z "$changed_files" ]; then
              environments="[]"
            else
              # Extract environment directories from changed files
              environments=$(echo "$changed_files" | \
                grep -E '\.(tf|tf\.json)$' | \
                xargs -I {} dirname {} | \
                grep -v '/\._' | \
                grep -v '/_' | \
                sed 's|infra/resources/||g' | \
                sort -u | \
                jq -R -s -c 'split("\n")[:-1] | map(select(length > 0))')
            fi
          fi
          
          echo "environments=$environments" >> $GITHUB_OUTPUT
          echo "Found environments with changes: $environments"
        env:
          GH_TOKEN: ${{ github.token }}

  generate_terraform:
    needs: detect_environments
    if: needs.detect_environments.outputs.environments != '[]'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --immutable

      - name: Generate Terraform code
        run: yarn turbo run infra:generate

      - name: Verify generated files
        run: |
          echo "Generated Terraform files:"
          find infra/ -name "*.tf.json" -type f || echo "No .tf.json files found"

      # Since the reusable workflow will checkout its own copy of the code,
      # the generated files need to be available. Options:
      # 1. Commit generated files to a temporary branch (not recommended for PR workflows)
      # 2. Modify the external reusable workflow to include generation
      # 3. Replace the reusable workflow with inline terraform plan logic
      # 4. Use a pre-commit hook or bot to ensure files are always generated

  code_review:
    needs: [detect_environments, generate_terraform] 
    if: needs.detect_environments.outputs.environments != '[]'
    strategy:
      matrix:
        environment: ${{ fromJson(needs.detect_environments.outputs.environments) }}
      fail-fast: false
    uses: pagopa/dx/.github/workflows/infra_plan.yaml@main
    name: Code Review Infra Plan (${{ matrix.environment }})
    secrets: inherit
    with:
      environment: ${{ matrix.environment }}
      override_github_environment: infra-dev
      base_path: infra/resources
