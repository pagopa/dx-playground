name: Convert Dot to Mermaid with Inference - PR

on:
  pull_request:
    types:
      - opened
      - synchronize
    # paths:
    #   - '**/graph.dot'
  workflow_dispatch:
    inputs:
      api_key:
        description: 'Azure OpenAI API Key'
        required: true
  # push:
  #   branches:
  #     - feat-poc-ai-graph-generation

jobs:
  find-changed-dots:
    runs-on: ubuntu-latest
    outputs:
      changed_files: ${{ steps.changed-files.outputs.all_changed_files }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find changed .dot files
        id: changed-files
        uses: tj-actions/changed-files@ed68ef82c095e0d48ec87eccea555d944a631a4c # v46
        with:
          files: '**/graph.dot'
          base_sha: 'main' # REMOVE
          matrix: true
      
      - name: Test print
        run: |
          echo "Changed files: ${{ steps.changed-files.outputs.all_changed_files }}"

  dot-to-mermaid:
    needs: find-changed-dots
    if: ${{ needs.find-changed-dots.outputs.changed_files != '[]' && needs.find-changed-dots.outputs.changed_files != '' }}
    
    runs-on: ubuntu-latest
    permissions:
      models: read
      contents: write
      pull-requests: write

    strategy:
      matrix:
        dot_file: ${{ fromJson(needs.find-changed-dots.outputs.changed_files) }}

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      - name: Generate Prompt for ${{ matrix.dot_file }}
        id: generate_prompt
        run: |
          PROMPT_FILE="prompt-$(echo "${{ matrix.dot_file }}" | tr '/' '-').txt"
          
          cat > "$PROMPT_FILE" <<EOF
          You are an expert in converting Terraform-generated Graphviz DOT diagrams into clear, human-friendly Mermaid diagrams.

          Requirements:
          0. **Wrap the entire output** inside a Markdown code fence with `mermaid`, exactly like this:
          \`\`\`mermaid
          …the entire diagram…
          \`\`\`
          1. **Output only valid Mermaid syntax** (no prose).
          2. **Orientation**: Use \`graph LR\` (left-to-right).
          3. **Subgraphs**: Group nodes into logical clusters with meaningful titles. Each subgraph block must be in the form:
            subgraph Group Title
              NodeA[“Label A”]
              NodeB[“Label B”]
            end
          4. **Naming**:  
            - Strip Terraform resource prefixes (\`azurerm_\`, \`data.\`) and use title-case labels (e.g. \`Key Vault Certificate\`, \`API Management Service\`).  
            - For DNS entries, include both zone and record type (\`A Record - apim.azure-api.net\`) if present.
          5. **Connections**:  
            - Draw arrows only once per relationship.  
            - Label edges only if it adds clarity (otherwise omit labels).
          6. **Clean Up**:  
            - Remove any standalone “management lock” or “diagnostic” nodes that don’t have outgoing or incoming edges—unless they’re essential.  
            - Collapse any trivial one-node subgraphs into their parent group.

          Here is the original DOT code:
          \`\`\`dot
          $(cat ./${{ matrix.dot_file }})
          \`\`\`
          EOF

          echo "Prompt file created at $PROMPT_FILE"
          echo "prompt_path=$PROMPT_FILE" >> $GITHUB_OUTPUT

      - name: Prepare JSON Payload
        id: prepare_json
        run: |
          JSON_FILE="payload-$(echo "${{ matrix.dot_file }}" | tr '/' '-').json"
          jq -n \
            --arg content "$(cat ${{ steps.generate_prompt.outputs.prompt_path }})" \
            '{
              "messages": [
                {
                  "role": "user",
                  "content": $content
                }
              ],
              "max_completion_tokens": 100000,
              "model": "o4-mini"
            }' > "$JSON_FILE"

          echo "JSON payload created at $JSON_FILE"
          echo "json_payload_path=$JSON_FILE" >> $GITHUB_OUTPUT

      - name: Run AI call API for ${{ matrix.dot_file }}
        id: ai_call
        env:
          AZURE_API_KEY: ${{ inputs.api_key }}
        run: |
          RESPONSE_FILE="response-$(echo "${{ matrix.dot_file }}" | tr '/' '-').json"

          curl -s -X POST "https://dx-d-sdc-test-aif-01.cognitiveservices.azure.com/openai/deployments/o4-mini/chat/completions?api-version=2025-01-01-preview" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $AZURE_API_KEY" \
            -d @p${{ steps.prepare_json.outputs.json_payload_path }} \
            -o "$RESPONSE_FILE"

          MERMAID_CONTENT=$(jq -r '.choices[0].message.content' "$RESPONSE_FILE")
          MERMAID_FILE="mermaid-diagram-$(echo "${{ matrix.dot_file }}" | tr '/' '-').md"
          echo "$MERMAID_CONTENT" > "$MERMAID_FILE"

          echo "AI response saved to: $MERMAID_FILE"
          echo "response_file=$MERMAID_FILE" >> $GITHUB_OUTPUT

      - name: Create Mermaid file from response
        id: create_md
        run: |
          DOT_DIR=$(dirname "${{ matrix.dot_file }}")
          MD_FILE_PATH="$DOT_DIR/graph.md"
          
          echo "AI Response saved to: ${{ steps.ai_call.outputs.response_file }}"
          
          mv "${{ steps.ai_call.outputs.response_file }}" "$MD_FILE_PATH"
          
          echo "Mermaid file created at: $MD_FILE_PATH"
          echo "md_file_path=$MD_FILE_PATH" >> $GITHUB_OUTPUT

      # - name: Commit and push graph.md
      #   uses: stefanzweifel/git-auto-commit-action@778341af668090896ca464160c2def5d1d1a3eb0 #v6
      #   with:
      #     commit_message: "docs: ✨ Generate Mermaid diagram for ${{ matrix.dot_file }}"
      #     file_pattern: "${{ steps.create_md.outputs.md_file_path }}"
      #     commit_user_name: "dx-pagopa-bot"
      #     commit_user_email: "dx-pagopa-github-bot@pagopa.it"
      #     commit_author: "dx-pagopa-bo <dx-pagopa-github-bot@pagopa.it>"

      - name: Upload Mermaid Artifact - TEST
        uses: actions/upload-artifact@v4
        with:
          name: "mermaid-diagram-${{ matrix.dot_file }}"
          path: ${{ steps.create_md.outputs.md_file_path }}
          if-no-files-found: error
          retention-days: 7