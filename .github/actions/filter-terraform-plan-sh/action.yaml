name: 'Run and Filter Terraform Plan'
description: 'Execute `terraform plan` and filter sensitive information from the output.'

inputs:
  base-path:
    description: 'The directory where terraform plan will be executed. (Defaults to the root of the repository)'
    required: false
    default: '.'
  sensitive-keys:
    description: 'A comma-separated list of sensitive keys to filter from the plan output.'
    required: true

outputs:
  filtered_plan:
    description: "The filtered output of the `terraform plan` command."
    value: ${{ steps.plan.outputs.filtered_plan }}

runs:
  using: "composite"
  steps:
    - name: Run Terraform Plan and Filter Output
      id: plan
      shell: bash
      run: |
        # Fail fast if no keys are provided
        if [[ -z "$SENSITIVE_KEYS" ]]; then
          echo "Error: The 'sensitive-keys' input is required."
          exit 1
        fi

        # --- Dynamically build the sed filter expressions ---
        # Using an array is safer for constructing commands with arguments than using a simple string
        declare -a SED_ARGS
        # Convert comma-separated string to newlines to loop safely
        for key in $(echo "${{ inputs.sensitive-keys }}" | tr ',' '\n'); do
          # Trim whitespace just in case
          trimmed_key=$(echo "$key" | xargs)
          if [[ -n "$trimmed_key" ]]; then
            # For each key, add '-e' and the expression as separate elements to the array
            SED_ARGS+=("-e")
            SED_ARGS+=("s/(\"?${trimmed_key}\"?\s*[:=]\s*)\".*?\"/\1\"[SENSITIVE]\"/I")
          fi
        done

        echo "--- Executing Plan in: $WORKING_DIRECTORY ---"
        cd "$WORKING_DIRECTORY"

        # Run terraform plan, capture its exit code
        # terraform plan -no-color -input=false 2>&1 | sed -E $SED_EXPRESSIONS | tee "$PLAN_FILE"
        FILTERED_PLAN=$(terraform plan -no-color -input=false 2>&1 | sed -E $SED_EXPRESSIONS)
        PLAN_EXIT_CODE=${PIPESTATUS[0]}

        echo "--- Plan executed with exit code: $PLAN_EXIT_CODE ---"

        # --- Set the action output ---
        EOF_MARKER=$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c 16)
        echo "filtered_plan<<$EOF_MARKER" >> $GITHUB_OUTPUT
        cat "$FILTERED_PLAN" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "$EOF_MARKER" >> $GITHUB_OUTPUT

        # Cleanup
        # rm "$PLAN_FILE"

        # --- Handle Exit Code ---
        # The step should FAIL ONLY on a true error (exit code 1)
        # It should SUCCEED for no changes (0) and changes detected (2)
        if [[ "$PLAN_EXIT_CODE" -eq 1 ]]; then
          echo "::error::Terraform plan failed with a critical error."
          exit 1
        fi
      env:
        WORKING_DIRECTORY: ${{ inputs.base-path }}
        GITHUB_ACTION_PATH: ${{ github.action_path }}
        SENSITIVE_KEYS: ${{ inputs.sensitive-keys }}
        PLAN_FILE: filtered_plan.txt
